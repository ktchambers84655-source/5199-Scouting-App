<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FRC Scouting (2026) — v1</title>
  <style>
    :root { --pad: 16px; --radius: 12px; --border: #d0d7de; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f6f8fa; color: #111; }
    .wrap { max-width: 720px; margin: 0 auto; padding: var(--pad); }
    .card { background: #fff; border: 1px solid var(--border); border-radius: var(--radius); padding: var(--pad); box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    h1 { font-size: 18px; margin: 0 0 8px; }
    .sub { font-size: 13px; color: #555; margin-bottom: 14px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row1 { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (max-width: 520px) { .row { grid-template-columns: 1fr; } }

    label { font-size: 13px; color: #333; display: block; margin-bottom: 6px; }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 16px;
      box-sizing: border-box;
      background: #fff;
    }
    textarea { min-height: 90px; resize: vertical; }
    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      padding: 12px 14px;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
    }
    .toggle {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .toggle .btn {
      width: 100%;
    }
    .toggle .btn.on {
      background: #e8f0fe;
      border-color: #c7d2fe;
      color: #1f3b8a;
      font-weight: 600;
    }

    .choice4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    @media (max-width: 520px) {
      .choice4 { grid-template-columns: 1fr 1fr; }
    }
    .choice4 .btn { width: 100%; }
    .choice4 .btn.on {
      background: #e8f0fe;
      border-color: #c7d2fe;
      color: #1f3b8a;
      font-weight: 600;
    }

    .btn.primary { background: #0b57d0; color: #fff; border-color: #0b57d0; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 10px; border: 1px solid var(--border); border-radius: 999px;
      font-size: 13px; color: #333; background: #fff;
    }
    .hidden { display: none !important; }
    .steps { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0 0; }
    .step { padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); font-size: 12px; color: #444; background: #fff; }
    .step.on { background: #e8f0fe; border-color: #c7d2fe; color: #1f3b8a; }
    .status { margin-top: 10px; font-size: 13px; }
    .ok { color: #0f7b2d; }
    .err { color: #b42318; }
    .topbar { display:flex; gap: 10px; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="pill">Season: <strong id="seasonLabel">2026</strong></div>
      <button class="btn" id="resetAllBtn" type="button" title="Clear saved scout name/event">Reset saved</button>
    </div>

    <div class="card">
      <h1>FRC Scouting — Match Submission (v1)</h1>
      <div class="sub">One scout per robot. Data submits to Google Sheets via Apps Script.</div>

      <div class="steps" id="steps">
        <div class="step on" data-step="0">Match Info</div>
        <div class="step" data-step="1">Auto</div>
        <div class="step" data-step="2">Teleop</div>
        <div class="step" data-step="3">Endgame</div>
        <div class="step" data-step="4">Notes</div>
      </div>

      <!-- Step 0: Match Info -->
      <div class="row1" id="step0">
        <div>
          <label for="event">Event</label>
          <select id="event">
            <option value="">Select event…</option>
            <option value="Ventura Regional">Ventura Regional</option>
            <option value="OC Regional">OC Regional</option>
            <option value="Champs">Champs</option>
            <option value="Test">Test</option>
          </select>

        </div>

        <div class="row">
          <div>
            <label for="matchNumber">Match #</label>
            <input id="matchNumber" type="number" inputmode="numeric" min="1" max="999" placeholder="e.g., 12" />
          </div>
          <div>
            <label for="teamNumber">Team #</label>
            <input id="teamNumber" type="number" inputmode="numeric" min="1" max="99999" placeholder="e.g., 4414" />
          </div>
        </div>

        <div class="row">
          <div class="pill" id="scoutingLabel">You are scouting: (not set)</div>
        </div>

        <div class="row">
          <div>
            <label for="scoutName">Scout Name</label>
            <input id="scoutName" type="text" placeholder="First name or initials" autocomplete="off" />
          </div>
          <div>
            <label for="alliance">Alliance</label>
            <select id="alliance">
              <option value="">Select…</option>
              <option value="red">Red</option>
              <option value="blue">Blue</option>
            </select>
          </div>
          <div>
            <label for="alliancePos">Alliance Position</label>
            <select id="alliancePos">
              <option value="">Select…</option>
              <option value="1">Drive Station 1</option>
              <option value="2">Drive Station 2</option>
              <option value="3">Drive Station 3</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Step 1: Auto -->
      <div class="row1 hidden" id="step1">
        <div class="row">
          <div>
            <label>Auto Mobility</label>
            <div class="toggle" data-toggle="autoMobility">
              <button class="btn" type="button" data-value="true">Yes</button>
              <button class="btn" type="button" data-value="false">No</button>
            </div>
            <!-- keep the select hidden for payload compatibility -->
            <select id="autoMobility" class="hidden">
              <option value="">Select…</option>
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>

          <div>
            <label>Auto Climb</label>
            <div class="toggle" data-toggle="autoClimb">
              <button class="btn" type="button" data-value="true">Yes</button>
              <button class="btn" type="button" data-value="false">No</button>
            </div>
            <select id="autoClimb" class="hidden">
              <option value="">Select…</option>
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
        </div>

        <div>
          <label>Auto Fuel Scored</label>
          <div class="choice4" data-toggle="autoFuel">
            <button class="btn" type="button" data-value="0">0</button>
            <button class="btn" type="button" data-value="1-9">1–9</button>
            <button class="btn" type="button" data-value="10-19">10–19</button>
            <button class="btn" type="button" data-value="20+">20+</button>
          </div>
          <select id="autoFuel" class="hidden">
            <option value="">Select…</option>
            <option value="0">0</option>
            <option value="1-9">1–9</option>
            <option value="10-19">10–19</option>
            <option value="20+">20+</option>
          </select>

          <div>
          <label>Record auto path?</label>
          <div class="toggle" data-toggle="autoPathEnabled">
            <button class="btn" type="button" data-value="true">Yes</button>
            <button class="btn" type="button" data-value="false">No</button>
          </div>
          <select id="autoPathEnabled" class="hidden">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>

        <div id="autoPathWrap" class="hidden">
          <label>Auto Path (optional)</label>

          <div style="position: relative; width: 100%; border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
            <img id="autoFieldImg" src="FIELD_IMAGE_URL_HERE" alt="Field map"
                style="display:block; width:100%; height:auto; user-select:none; -webkit-user-drag:none;" />
            <canvas id="autoPathCanvas"
                    style="position:absolute; left:0; top:0; width:100%; height:100%; touch-action:none;"></canvas>
          </div>

          <div class="row" style="margin-top: 10px;">
            <button class="btn" type="button" id="autoPathUndoBtn">Undo</button>
            <button class="btn" type="button" id="autoPathClearBtn">Clear</button>
          </div>

          <div class="sub" style="margin: 8px 0 0;">
            Tip: Use your finger/stylus. Undo removes the last stroke.
          </div>
        </div>
        </div>

        <button class="btn" type="button" id="autoClearBtn">Clear Auto</button>
      </div>

      <!-- Step 2: Teleop -->
      <div class="row1 hidden" id="step2">
        <div>
          <label for="teleopAttemptShoot">Attempted to shoot (teleop)?</label>
          <select id="teleopAttemptShoot">
            <option value="">Select…</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>

        <div class="row">
          <div>
            <label for="teleopCycles">Teleop Cycles</label>
            <input id="teleopCycles" type="number" inputmode="numeric" min="0" max="99" placeholder="0–99" />
          </div>
        
          <div>
            <label for="robotType">Robot Type</label>
            <select id="robotType">
              <option value="">Select…</option>
              <option value="trench">Trench robot</option>
              <option value="bump">Bump robot</option>
              <option value="both">Both</option>
            </select>
          </div>
        </div>

        <div id="accuracyWrap" class="hidden">
          <label for="teleopAccuracy">Teleop Accuracy</label>
          <select id="teleopAccuracy">
            <option value="">Select…</option>
            <option value="very_inaccurate">Very inaccurate</option>
            <option value="inaccurate">Inaccurate</option>
            <option value="mixed">Mixed</option>
            <option value="accurate">Accurate</option>
            <option value="very_accurate">Very accurate</option>
          </select>
        </div>
      </div>

      <!-- Step 3: Endgame -->
      <div class="row1 hidden" id="step3">
        <div>
          <label for="endgameTowerLevel">Endgame Tower Level</label>
          <select id="endgameTowerLevel">
            <option value="">Select…</option>
            <option value="none">None</option>
            <option value="l1">Level 1</option>
            <option value="l2">Level 2</option>
            <option value="l3">Level 3</option>
          </select>
        </div>

        <div class="row">
          <div>
            <label for="diedDisabled">Died / Disabled?</label>
            <select id="diedDisabled">
              <option value="">Select…</option>
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
          <div>
            <label for="foulsObserved">Fouls Observed</label>
            <select id="foulsObserved">
              <option value="">Select…</option>
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3+">3+</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Step 4: Notes -->
      <div class="row1 hidden" id="step4">
        <div>
          <label for="notes">Notes</label>
          <textarea id="notes" placeholder="Short notes (optional)"></textarea>
        </div>

        <div>
          <label for="confidence">Confidence (1–5)</label>
          <select id="confidence">
            <option value="">Select…</option>
            <option value="1">1 (Low)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (High)</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top: 14px;">
        <button class="btn" type="button" id="backBtn">Back</button>
        <button class="btn primary" type="button" id="nextBtn">Next</button>
      </div>

      <div class="status" id="status"></div>
    </div>
  </div>

  <script>
    // IMPORTANT: Put your Apps Script Web App /exec URL here.
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxxsQ1thfUxl-3_M96gVC0tnNiIHt_6yRGkGgX_WxWA97a3qepretxq6mmdmRjikA7I/exec";

    const SEASON = "2026";
    document.getElementById("seasonLabel").textContent = SEASON;

    const els = {
      event: document.getElementById("event"),
      matchNumber: document.getElementById("matchNumber"),
      teamNumber: document.getElementById("teamNumber"),
      scoutName: document.getElementById("scoutName"),
      alliance: document.getElementById("alliance"),
      alliancePos: document.getElementById("alliancePos"),
      scoutingLabel: document.getElementById("scoutingLabel"),

      autoMobility: document.getElementById("autoMobility"),
      autoClimb: document.getElementById("autoClimb"),
      autoFuel: document.getElementById("autoFuel"),
      autoPathEnabled: document.getElementById("autoPathEnabled"),
      autoPathWrap: document.getElementById("autoPathWrap"),
      autoFieldImg: document.getElementById("autoFieldImg"),
      autoPathCanvas: document.getElementById("autoPathCanvas"),
      autoPathUndoBtn: document.getElementById("autoPathUndoBtn"),
      autoPathClearBtn: document.getElementById("autoPathClearBtn"),


      teleopAttemptShoot: document.getElementById("teleopAttemptShoot"),
      accuracyWrap: document.getElementById("accuracyWrap"),
      teleopAccuracy: document.getElementById("teleopAccuracy"),
      teleopCycles: document.getElementById("teleopCycles"),
      robotType: document.getElementById("robotType"),

      endgameTowerLevel: document.getElementById("endgameTowerLevel"),
      diedDisabled: document.getElementById("diedDisabled"),
      foulsObserved: document.getElementById("foulsObserved"),

      notes: document.getElementById("notes"),
      confidence: document.getElementById("confidence"),

      backBtn: document.getElementById("backBtn"),
      nextBtn: document.getElementById("nextBtn"),
      status: document.getElementById("status"),
      resetAllBtn: document.getElementById("resetAllBtn"),
      steps: document.getElementById("steps"),
    };

    const stepIds = ["step0", "step1", "step2", "step3", "step4"];
    let step = 0;
    let isSubmitting = false;

    // Persist scout name + event for convenience
    const LS_SCOUT = "frc_scout_name";
    const LS_EVENT = "frc_event_name";
    const LS_ALLIANCE = "frc_alliance";
    const LS_ALLIANCE_POS = "frc_alliance_pos";
    const LS_MATCH = "frc_last_match_number";
    const LS_EVENT_KEY = "frc_event_key";


    function setStatus(msg, kind) {
      els.status.textContent = msg || "";
      els.status.className = "status " + (kind ? kind : "");
    }

    function showStep(n) {
      step = n;

      stepIds.forEach((id, i) => {
        const node = document.getElementById(id);
        if (i === n) node.classList.remove("hidden");
        else node.classList.add("hidden");
      });

      [...els.steps.querySelectorAll(".step")].forEach((s) => {
        const idx = Number(s.getAttribute("data-step"));
        if (idx === n) s.classList.add("on");
        else s.classList.remove("on");
      });

      els.backBtn.disabled = (n === 0) || isSubmitting;
      els.nextBtn.disabled = isSubmitting;

      els.nextBtn.textContent = (n === stepIds.length - 1) ? "Submit" : "Next";
      setStatus("");
      updateTeleopConditionalUI();
      if (n === 1) {
        wireToggleGroup("autoMobility", els.autoMobility);
        wireToggleGroup("autoClimb", els.autoClimb);
        wireToggleGroup("autoFuel", els.autoFuel);
        updateAutoPathUI();
      }

    }

    function updateTeleopConditionalUI() {
      const val = els.teleopAttemptShoot.value;
      if (val === "true") {
        els.accuracyWrap.classList.remove("hidden");
      } else {
        els.accuracyWrap.classList.add("hidden");
        els.teleopAccuracy.value = "";
      }
    }

    function parseBool(v) {
      if (v === "true") return true;
      if (v === "false") return false;
      return null;
    }

    function requireField(condition, message) {
      if (!condition) throw new Error(message);
    }

    function validateCurrentStepOrThrow() {
      if (step === 0) {
        requireField(els.event.value.trim().length > 0, "Event is required.");
        requireField(els.scoutName.value.trim().length >= 2, "Scout Name is required (>= 2 chars).");
        requireField(els.alliance.value === "red" || els.alliance.value === "blue", "Alliance is required.");
        const mn = Number(els.matchNumber.value);
        const tn = Number(els.teamNumber.value);
        requireField(Number.isFinite(mn) && mn >= 1, "Match # must be >= 1.");
        requireField(Number.isFinite(tn) && tn >= 1, "Team # must be >= 1.");
        requireField(els.alliancePos.value === "1" || els.alliancePos.value === "2" || els.alliancePos.value === "3",
         "Alliance Position is required.");
      }

      if (step === 1) {
        requireField(parseBool(els.autoMobility.value) !== null, "Auto Mobility is required.");
        requireField(parseBool(els.autoClimb.value) !== null, "Auto Climb is required.");
        requireField(els.autoFuel.value.trim().length > 0, "Auto Fuel Scored is required.");
      }


      if (step === 2) {
        const tas = parseBool(els.teleopAttemptShoot.value);
        requireField(tas !== null, "Teleop: attempted to shoot is required.");
        if (tas === true) {
          requireField(els.teleopAccuracy.value.trim().length > 0, "Teleop Accuracy is required if they shot.");
        }
        const cycles = Number(els.teleopCycles.value);
        requireField(Number.isFinite(cycles) && cycles >= 0, "Teleop Cycles must be a number >= 0.");
        
        requireField(
          els.robotType.value === "trench" || els.robotType.value === "bump" || els.robotType.value === "both",
          "Robot Type is required."
        );

      }

      if (step === 3) {
        requireField(els.endgameTowerLevel.value.trim().length > 0, "Endgame Tower Level is required.");
        requireField(parseBool(els.diedDisabled.value) !== null, "Died/Disabled is required.");
        requireField(els.foulsObserved.value.trim().length > 0, "Fouls Observed is required.");
      }

      if (step === 4) {
        requireField(els.confidence.value.trim().length > 0, "Confidence is required.");
      }
    }

    function buildPayload() {
      const event = els.event.value.trim();
      const scoutName = els.scoutName.value.trim();

      const matchNumber = Number(els.matchNumber.value);
      const teamNumber = Number(els.teamNumber.value);

      requireField(event.length > 0, "Event is required.");
      requireField(scoutName.length >= 2, "Scout Name is required (at least 2 chars).");
      requireField(Number.isFinite(matchNumber) && matchNumber >= 1, "Match # must be a number >= 1.");
      requireField(Number.isFinite(teamNumber) && teamNumber >= 1, "Team # must be a number >= 1.");
      requireField(els.alliance.value === "red" || els.alliance.value === "blue", "Alliance is required.");

      const autoMobility = parseBool(els.autoMobility.value);
      const autoClimb = parseBool(els.autoClimb.value);
      requireField(autoMobility !== null, "Auto Mobility is required.");
      requireField(autoClimb !== null, "Auto Climb is required.");

      const autoFuel = els.autoFuel.value.trim();
      requireField(autoFuel.length > 0, "Auto Fuel Scored is required.");

      const autoPathEnabled = els.autoPathEnabled.value === "true";
      const autoPath = (autoPathEnabled && autoPathStrokes.length > 0)
        ? { strokes: autoPathStrokes }
        : null;

      const teleopAttemptShoot = parseBool(els.teleopAttemptShoot.value);
      requireField(teleopAttemptShoot !== null, "Teleop: attempted to shoot is required.");

      const teleopCycles = Number(els.teleopCycles.value);
      requireField(Number.isFinite(teleopCycles) && teleopCycles >= 0, "Teleop Cycles must be a number >= 0.");
      
      const robotType = els.robotType.value.trim();
      requireField(robotType.length > 0, "Robot Type is required.");

      const teleopAccuracy = els.teleopAccuracy.value.trim();
      if (teleopAttemptShoot === true) {
        requireField(teleopAccuracy.length > 0, "Teleop Accuracy is required if they attempted to shoot.");
      }

      requireField(els.endgameTowerLevel.value.trim().length > 0, "Endgame Tower Level is required.");

      const diedDisabled = parseBool(els.diedDisabled.value);
      requireField(diedDisabled !== null, "Died/Disabled is required.");

      requireField(els.foulsObserved.value.trim().length > 0, "Fouls Observed is required.");

      requireField(els.confidence.value.trim().length > 0, "Confidence is required.");

      localStorage.setItem(LS_SCOUT, scoutName);
      localStorage.setItem(LS_EVENT, event);

      return {
        season: SEASON,
        event: event,
        match_number: matchNumber,
        team_number: teamNumber,
        scout_name: scoutName,
        alliance: els.alliance.value,
        alliance_pos: els.alliancePos.value,


        auto_mobility: autoMobility,
        auto_climb: autoClimb,
        auto_fuel_est: autoFuel,
        auto_path: autoPath,


        teleop_attempt_shoot: teleopAttemptShoot,
        teleop_accuracy: teleopAttemptShoot ? teleopAccuracy : "",
        teleop_cycles: Math.trunc(teleopCycles),
        robot_type: robotType,
        
        endgame_tower_level: els.endgameTowerLevel.value,

        died_disabled: diedDisabled,
        fouls_observed: els.foulsObserved.value,

        notes: els.notes.value.trim(),
        confidence: Number(els.confidence.value),
      };
    }

    async function submit() {
      if (!WEB_APP_URL || WEB_APP_URL === "WEB_APP_URL_HERE") {
        throw new Error("WEB_APP_URL is not set.");
      }
      if (!WEB_APP_URL.startsWith("https://script.google.com/macros/s/") || !WEB_APP_URL.endsWith("/exec")) {
        throw new Error("WEB_APP_URL must be your Apps Script /exec URL.");
      }

      const payload = buildPayload();

      isSubmitting = true;
      els.nextBtn.disabled = true;
      els.backBtn.disabled = true;
      setStatus("Submitting…", "");

      // Use text/plain to avoid CORS preflight issues with Apps Script.
      const res = await fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload),
      });

      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch (_) {}

      isSubmitting = false;
      els.nextBtn.disabled = false;
      els.backBtn.disabled = (step === 0);

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${text}`);
      }
      if (json && json.ok === false) {
        throw new Error(json.error || "Submission failed.");
      }

      setStatus("Submitted successfully. Ready for the next robot.", "ok");
      localStorage.setItem(LS_MATCH, String(Number(els.matchNumber.value)));
      localStorage.setItem(LS_ALLIANCE, els.alliance.value);
      localStorage.setItem(LS_ALLIANCE_POS, els.alliancePos.value);
      resetForNext();
    }

    function updateScoutingLabel_() {
      const eventName = els.event.value.trim() || "(event)";
      const mn = els.matchNumber.value.trim() ? `Match ${els.matchNumber.value.trim()}` : "Match ?";
      const a = els.alliance.value ? els.alliance.value.toUpperCase() : "ALLIANCE ?";
      const p = els.alliancePos.value ? els.alliancePos.value : "?";
      const tn = els.teamNumber.value.trim();

      const teamPart = tn ? `Team ${tn}` : "Team ?";
      els.scoutingLabel.textContent = `You are scouting: ${eventName} • ${mn} • ${a} ${p} — ${teamPart}`;
}

    function eventNameToTbaKey_(eventName) {
      // Replace with your actual 2026 TBA event keys
      const map = {
        "Ventura Regional": "2026caven",
        "OC Regional": "2026caoec",
        "Champs": "2026cmp",  // example only
        "Test": "2026test",   // example only
      };
      return map[eventName] || "";
    }
    
    async function maybeAutofillTeam_() {
      if (els.teamNumber.value.trim() !== "") {
        updateScoutingLabel_();
        return;
      }
    
      const eventName = els.event.value.trim();
      const matchNumber = Number(els.matchNumber.value);
      const alliance = els.alliance.value;
      const pos = els.alliancePos.value;
    
      if (!eventName || !Number.isFinite(matchNumber) || matchNumber < 1 || !alliance || !pos) return;
    
      const eventKey = eventNameToTbaKey_(eventName);
      if (!eventKey) return;
    
      try {
        const url = `${WEB_APP_URL}?action=tba_match_team&event_key=${encodeURIComponent(eventKey)}&match_number=${encodeURIComponent(matchNumber)}&alliance=${encodeURIComponent(alliance)}&position=${encodeURIComponent(pos)}`;
        const res = await fetch(url, { method: "GET" });
        const data = await res.json();
    
        if (data && data.ok && data.team_number) {
          els.teamNumber.value = String(data.team_number);
          updateScoutingLabel_();
        }
      } catch (_) {}
    }

    function resetForNext() {
      // Keep event + scout name, clear match/team and performance fields
      const savedMatch = localStorage.getItem(LS_MATCH);
      if (savedMatch) {
        const n = Number(savedMatch);
        els.matchNumber.value = (Number.isFinite(n) && n >= 1) ? String(n + 1) : "";
      } else {
        els.matchNumber.value = "";
      }

      els.teamNumber.value = "";
      // Keep the assignment defaults between robots
      els.alliance.value = localStorage.getItem(LS_ALLIANCE) || "red";
      els.alliancePos.value = localStorage.getItem(LS_ALLIANCE_POS) || "1";


      els.autoMobility.value = "";
      els.autoClimb.value = "";
      els.autoFuel.value = "";
      els.autoPathEnabled.value = "false";
      updateAutoPathUI();
      clearAutoPath_();


      els.teleopAttemptShoot.value = "";
      els.teleopAccuracy.value = "";
      els.teleopCycles.value = "";
      els.robotType.value = "";

      updateTeleopConditionalUI();

      els.endgameTowerLevel.value = "";
      els.diedDisabled.value = "";
      els.foulsObserved.value = "";

      els.notes.value = "";
      els.confidence.value = "";

      showStep(0);
      setTimeout(() => els.matchNumber.focus(), 50);
    }

    function loadSaved() {
      const savedScout = localStorage.getItem(LS_SCOUT);
      const savedEvent = localStorage.getItem(LS_EVENT);
      const savedAlliance = localStorage.getItem(LS_ALLIANCE);
      const savedPos = localStorage.getItem(LS_ALLIANCE_POS);
      const savedMatch = localStorage.getItem(LS_MATCH);
    
      if (savedScout) els.scoutName.value = savedScout;
      if (savedEvent) els.event.value = savedEvent;
    
      if (savedAlliance) els.alliance.value = savedAlliance;
      if (savedPos) els.alliancePos.value = savedPos;
    
      // Auto-increment match number (+1)
      if (savedMatch) {
        const n = Number(savedMatch);
        if (Number.isFinite(n) && n >= 0) els.matchNumber.value = String(n + 1);
      }
      // If nothing saved yet, default to Red DS1
      if (!els.alliance.value) els.alliance.value = "red";
      if (!els.alliancePos.value) els.alliancePos.value = "1";

      updateScoutingLabel_();
    }

    function clearSaved() {
      localStorage.removeItem(LS_SCOUT);
      localStorage.removeItem(LS_EVENT);
      els.scoutName.value = "";
      els.event.value = "";
      localStorage.removeItem(LS_ALLIANCE);
      localStorage.removeItem(LS_ALLIANCE_POS);
      localStorage.removeItem(LS_MATCH);
      setStatus("Cleared saved scout name and event.", "");
    }

    const _wiredToggles = new Set();

    function setToggleValue(selectEl, wrapEl, value) {
      selectEl.value = value || "";
      const buttons = wrapEl.querySelectorAll('button[data-value]');
      buttons.forEach((b) => b.classList.remove("on"));
      if (!value) return;
      buttons.forEach((b) => {
        b.classList.toggle("on", b.getAttribute("data-value") === value);
      });
    }

    function wireToggleGroup(toggleAttr, selectEl) {
      const wrap = document.querySelector(`[data-toggle="${toggleAttr}"]`);
      if (!wrap) return;

      // prevent double-wiring
      if (_wiredToggles.has(toggleAttr)) {
        if (selectEl.value) setToggleValue(selectEl, wrap, selectEl.value);
        return;
      }
      _wiredToggles.add(toggleAttr);

      wrap.querySelectorAll('button[data-value]').forEach((btn) => {
        btn.addEventListener("click", () => {
          const value = btn.getAttribute("data-value");
          setToggleValue(selectEl, wrap, value);
          selectEl.dispatchEvent(new Event("change"));
        });
      });

      // default if empty and has a "false" option
      if (!selectEl.value && [...selectEl.options].some(o => o.value === "false")) {
        selectEl.value = "false";
      }

      setToggleValue(selectEl, wrap, selectEl.value);
    }

    function updateAutoPathUI() {
      const enabled = els.autoPathEnabled.value === "true";
      if (enabled) els.autoPathWrap.classList.remove("hidden");
      else els.autoPathWrap.classList.add("hidden");
    }

    els.autoPathEnabled.addEventListener("change", () => {
      updateAutoPathUI();
    });

    let autoPathStrokes = []; // [{pts:[[xN,yN],...]}]
    let _drawing = false;
    let _currentStroke = null;
    let _ctx = null;

    function resizeCanvasToImage_() {
      const canvas = els.autoPathCanvas;
      const img = els.autoFieldImg;
      if (!canvas || !img) return;

      const rect = img.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;

      canvas.width = Math.max(1, Math.round(rect.width * dpr));
      canvas.height = Math.max(1, Math.round(rect.height * dpr));

      canvas.style.width = rect.width + "px";
      canvas.style.height = rect.height + "px";

      _ctx = canvas.getContext("2d");
      _ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // draw in CSS pixels
      redrawAutoPath_();
    }

    function getNormPoint_(e) {
      const rect = els.autoPathCanvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;
      // clamp
      return [Math.max(0, Math.min(1, x)), Math.max(0, Math.min(1, y))];
    }

    function redrawAutoPath_() {
      if (!_ctx) return;
      const canvas = els.autoPathCanvas;
      const rect = canvas.getBoundingClientRect();
      _ctx.clearRect(0, 0, rect.width, rect.height);

      _ctx.lineCap = "round";
      _ctx.lineJoin = "round";
      _ctx.lineWidth = 4;
      _ctx.strokeStyle = "#111";

      autoPathStrokes.forEach((s) => {
        const pts = s.pts;
        if (!pts || pts.length < 2) return;
        _ctx.beginPath();
        _ctx.moveTo(pts[0][0] * rect.width, pts[0][1] * rect.height);
        for (let i = 1; i < pts.length; i++) {
          _ctx.lineTo(pts[i][0] * rect.width, pts[i][1] * rect.height);
        }
        _ctx.stroke();
      });
    }

    function wireAutoCanvas_() {
      const canvas = els.autoPathCanvas;
      if (!canvas) return;

      // Ensure we only wire once
      if (canvas._wired) return;
      canvas._wired = true;

      canvas.addEventListener("pointerdown", (e) => {
        if (els.autoPathEnabled.value !== "true") return;
        _drawing = true;
        canvas.setPointerCapture(e.pointerId);
        _currentStroke = { pts: [getNormPoint_(e)] };
        autoPathStrokes.push(_currentStroke);
        redrawAutoPath_();
      });

      canvas.addEventListener("pointermove", (e) => {
        if (!_drawing || !_currentStroke) return;
        _currentStroke.pts.push(getNormPoint_(e));
        redrawAutoPath_();
      });

      function end(e) {
        if (!_drawing) return;
        _drawing = false;
        _currentStroke = null;
        try { canvas.releasePointerCapture(e.pointerId); } catch (_) {}
      }

      canvas.addEventListener("pointerup", end);
      canvas.addEventListener("pointercancel", end);
    }

    function clearAutoPath_() {
      autoPathStrokes = [];
      redrawAutoPath_();
    }







    // Wiring
    els.teleopAttemptShoot.addEventListener("change", updateTeleopConditionalUI);
    els.resetAllBtn.addEventListener("click", clearSaved);

    els.alliance.addEventListener("change", () => {
      localStorage.setItem(LS_ALLIANCE, els.alliance.value);
      updateScoutingLabel_();
      maybeAutofillTeam_();
    });

    els.teamNumber.addEventListener("input", updateScoutingLabel_);
    
    els.alliancePos.addEventListener("change", () => {
      localStorage.setItem(LS_ALLIANCE_POS, els.alliancePos.value);
      maybeAutofillTeam_();
    });
    
    els.matchNumber.addEventListener("change", () => {
      maybeAutofillTeam_();
    });
    
    els.event.addEventListener("change", () => {
      localStorage.setItem(LS_EVENT, els.event.value);
      maybeAutofillTeam_();
    });
    
    els.scoutName.addEventListener("change", () => {
      localStorage.setItem(LS_SCOUT, els.scoutName.value.trim());
    });


    els.backBtn.addEventListener("click", () => {
      if (isSubmitting) return;
      showStep(Math.max(0, step - 1));
    });

    els.nextBtn.addEventListener("click", async () => {
      if (isSubmitting) return;

      try {
        if (step < stepIds.length - 1) {
          validateCurrentStepOrThrow();
          showStep(step + 1);
          return;
        }
        await submit();
      } catch (err) {
        setStatus(err.message || String(err), "err");
      }
    });

    wireToggleGroup("autoMobility", els.autoMobility);
    wireToggleGroup("autoClimb", els.autoClimb);
    wireToggleGroup("autoFuel", els.autoFuel);
    wireToggleGroup("autoMobility", els.autoMobility);
    wireToggleGroup("autoClimb", els.autoClimb);
    wireToggleGroup("autoFuel", els.autoFuel);
    wireToggleGroup("autoPathEnabled", els.autoPathEnabled);

    els.autoMobility.addEventListener("change", () => {
      if (els.autoMobility.value === "false") {
        els.autoPathEnabled.value = "false";
        updateAutoPathUI();
        clearAutoPath_();
      }
    });


    els.autoFieldImg.addEventListener("load", resizeCanvasToImage_);
    window.addEventListener("resize", resizeCanvasToImage_);
    wireAutoCanvas_();

    els.autoPathUndoBtn.addEventListener("click", () => {
      autoPathStrokes.pop();
      redrawAutoPath_();
    });
    els.autoPathClearBtn.addEventListener("click", () => {
      clearAutoPath_();
    });




    const autoClearBtn = document.getElementById("autoClearBtn");
    if (autoClearBtn) {
      autoClearBtn.addEventListener("click", () => {
        els.autoMobility.value = "";
        els.autoClimb.value = "";
        els.autoFuel.value = "";

        const m = document.querySelector('[data-toggle="autoMobility"]');
        const c = document.querySelector('[data-toggle="autoClimb"]');
        const f = document.querySelector('[data-toggle="autoFuel"]');

        if (m) setToggleValue(els.autoMobility, m, "");
        if (c) setToggleValue(els.autoClimb, c, "");
        if (f) setToggleValue(els.autoFuel, f, "");

        setStatus("Cleared Auto fields.", "");
      });
    }



    // Init
    loadSaved();
    showStep(0);
  </script>
</body>
</html>
